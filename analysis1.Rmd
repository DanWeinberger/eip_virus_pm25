---
title: "analysis1"
output: html_document
date: "2024-08-28"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(ggplot2)
library(viridis)
library(plotly)
library(scales)
library(pheatmap)
#install.packages("waffle", repos = "https://cinc.rud.is") 
library(reshape2)
#library(HDInterval)
library(rjags)
library(stringr)
library(tidyr)
library(tidybayes)

```

read in data

```{r}

ds0 <- read.csv('./Data/CONFIDENTIAL/AddingFlu_RSV.csv') %>%
  mutate(date =as.Date(date,'%m/%d/%Y'),)

ds1 <- read.csv('./Data/CONFIDENTIAL/CovidNet_AQ_Weather_08292024.csv') %>%
  rename(pm2_5=PM2.5_Avg, humid=site_avg_RelH) %>%
 mutate( date =as.Date(date,'%m/%d/%Y'),
    day_of_week=as.factor(weekdays(date)),
    
    pm2_5=scale(log(pm2_5)),
          pm2_5_lag0=pm2_5,
          pm2_5_lag1 =lag(pm2_5,1),
          pm2_5_lag2 =lag(pm2_5,2),
          pm2_5_lag3 =lag(pm2_5,3),
          pm2_5_lag4 =lag(pm2_5,4),
          pm2_5_lag5 =lag(pm2_5,5),
          pm2_5_lag6 =lag(pm2_5,6),
          pm2_5_lag7 =lag(pm2_5,7),
          pm2_5_lag8 =lag(pm2_5,8),
          pm2_5_lag9 =lag(pm2_5,9),
          pm2_5_lag10 =lag(pm2_5,10),
          pm2_5_lag11 =lag(pm2_5,11),
          pm2_5_lag12 =lag(pm2_5,12),
          pm2_5_lag13 =lag(pm2_5,13),
          pm2_5_lag14 =lag(pm2_5,14),
    
    humid=scale(humid),
            humid_lag0 =humid,
            humid_lag1=lag(humid,1),
            humid_lag2=lag(humid,2),
            humid_lag3=lag(humid,3),
            humid_lag4=lag(humid,4),
            humid_lag5=lag(humid,5),
            humid_lag6=lag(humid,6),
            humid_lag7=lag(humid,7),
            humid_lag8=lag(humid,8),
            humid_lag9=lag(humid,9),
            humid_lag10=lag(humid,10),
            humid_lag11=lag(humid,11),
            humid_lag12=lag(humid,12),
            humid_lag13=lag(humid,13),
            humid_lag14=lag(humid,14)
          ) %>%
  filter(!is.na(Cases_Total) & !is.na(humid_lag0)) %>%
  left_join(ds0, by='date')

 pm2_5_mat <- ds1 %>%
   select(starts_with('pm2_5_lag')) %>%
   as.matrix()
 
  humid_mat <- ds1 %>%
   select(starts_with('humid_lag')) %>%
   as.matrix()
 
 
 dow_mat <- model.matrix(~day_of_week, data=ds1) 
 dow_mat <- dow_mat[,-1] #remove intercept
 
```




### Define the model 
```{r}

model_string <- "

model{
for(i in 1:Ntimes){

  cases[i] ~ dnegbin(prob[i],r)
  prob[i]<- r/(r+lambda[i])  ## likelihood 

  log(lambda[i]) <-   alpha[i] +inprod(delta[],dow_mat[i,]) +
                    inprod(epsilon[],pm2_5_mat[i,]) +
                    inprod(eta[],   humid_mat[i,])
  

}

#AR1 random intercept
  alpha[1] ~ dnorm(mu0  , (1 - rho1^2) * tau.alpha1) # Prior for the first time point
  for(i in 2:Ntimes){
    alpha[i] ~ dnorm( mu0  + rho1 * (alpha[i-1]-mu0), tau.alpha1)
  }
  
  #day of week effects
  for(k in 1:6){
    delta[k]~dnorm(0,1e-4)
  }
  
  
  epsilon[1] ~ dnorm(0, (1 - rho2^2) * tau.epsilon2)
  for(m in 2:15){
    epsilon[m] ~ dnorm(rho2 *epsilon[m-1] , tau.epsilon2)
  }
  
  eta[1] ~ dnorm(0, (1 - rho3^2) * tau.eta2)
  for(m in 2:15){
    eta[m] ~ dnorm(rho3 *eta[m-1] , tau.eta2)
  }
  

  tau.alpha1 ~ dgamma(3, 2)  # Tight prior for tau 
  tau.epsilon2 ~ dgamma(3, 2)  # Tight prior for tau 
  tau.eta2 ~ dgamma(3, 2)  # Tight prior for tau 

  rho1 ~ dunif(0, 1)       # Uniform prior for rho
  rho2 ~ dunif(0, 1)       # Uniform prior for rho
  rho3 ~ dunif(0, 1)       # Uniform prior for rho

  mu0 ~ dnorm(0, 1e-4)   # Uninformative prior for intercept
  
  r ~ dunif(0,250)

}
"
```

### Set random seeds. 
We are going to run 3 chains in the MCMC, so we need a seed for each. This ensures reproducible results.

```{r}
inits1=list(".RNG.seed"=c(123), ".RNG.name"='base::Wichmann-Hill')
inits2=list(".RNG.seed"=c(456), ".RNG.name"='base::Wichmann-Hill')
inits3=list(".RNG.seed"=c(789), ".RNG.name"='base::Wichmann-Hill')
```

### Initialize the model for COVID
```{r}
model_spec<-textConnection(model_string)
model_jags<-jags.model(model_spec,
                       inits=list(inits1,inits2, inits3),
                       data=list('Ntimes'= nrow(ds1)  ,
                                 'cases'= ds1$Cases_Total,
                                 'pm2_5_mat'=pm2_5_mat,
                                 'dow_mat'=dow_mat,
                                 'humid_mat'=humid_mat
                       ),
                       n.adapt=15000,
                       n.chains=3, quiet=F)
```

### Posterior sampling

what parameters do you want to sample?
```{r}
params<-c('rho1', 'mu0','alpha','tau.alpha1','lambda', 'epsilon','eta')

```

```{r}
posterior_samples<-coda.samples(model_jags, 
                                params, 
                                n.iter=10000)
```
## examine lambda
```{r}
test <- gather_draws(posterior_samples, lambda[i])

test %>%
  filter(i==1) %>%
  mutate(.chain=as.factor(.chain)) %>%
ggplot( aes(x=.iteration, y=.value, group=.chain, color=.chain), alpha=0.2) +
  geom_line()+
  theme_classic()


```

```{r}
test <- gather_draws(posterior_samples, epsilon[i])

test %>%
  filter(i==1) %>%
  mutate(.chain=as.factor(.chain)) %>%
ggplot( aes(x=.iteration, y=.value, group=.chain, color=.chain), alpha=0.2) +
  geom_line()+
  theme_classic()


```

```{r}
test <- gather_draws(posterior_samples, eta[i])

test %>%
  filter(i==1) %>%
  mutate(.chain=as.factor(.chain)) %>%
ggplot( aes(x=.iteration, y=.value, group=.chain, color=.chain), alpha=0.2) +
  geom_line()+
  theme_classic()


```

HDI for lambda
```{r}
lambda_quant <- test %>%
  median_hdi()

ggplot(lambda_quant, aes(x=i, y=.value)) +
  geom_line()+
  theme_minimal()
```


### distributed lag for COVID
```{r}
dl_summary <- gather_draws(posterior_samples, epsilon[m]) %>%
  median_hdi()

ggplot(dl_summary, aes(x=m, y=.value)) +
  geom_line()+
  geom_ribbon(aes(x=m, ymin=.lower, ymax=.upper), alpha=0.2)+
  theme_minimal()+
  geom_hline(yintercept=0, lty=2)

test <- gather_draws(posterior_samples, epsilon[i])

test %>%
  filter(i==1) %>%
  mutate(.chain=as.factor(.chain)) %>%
ggplot( aes(x=.iteration, y=.value, group=.chain, color=.chain), alpha=0.2) +
  geom_line()+
  theme_classic()
```

distributed lag eta (humidity)
```{r}
dl_summary <- gather_draws(posterior_samples, eta[m]) %>%
  median_hdi()

ggplot(dl_summary, aes(x=m, y=.value)) +
  geom_line()+
  geom_ribbon(aes(x=m, ymin=.lower, ymax=.upper), alpha=0.2)+
  theme_classic()+
  geom_hline(yintercept=0, lty=2)

```


### AR1 component
```{r}
ar1_summary <- gather_draws(posterior_samples, alpha[i]) %>%
  median_hdi()

ggplot(ar1_summary, aes(x=i, y=.value)) +
  geom_line()+
  geom_ribbon(aes(x=i, ymin=.lower, ymax=.upper), alpha=0.2)+
  theme_minimal()

```


## Same model for Flu

### Initialize the model for COVID
```{r}
model_spec<-textConnection(model_string)
model_jags_flu<-jags.model(model_spec,
                       inits=list(inits1,inits2, inits3),
                       data=list('Ntimes'= nrow(ds1)  ,
                                 'cases'= ds1$Flu_Total,
                                 'pm2_5_mat'=pm2_5_mat,
                                 'dow_mat'=dow_mat,
                                 'humid_mat'=humid_mat
                       ),
                       n.adapt=15000,
                       n.chains=3, quiet=F)
```

### Posterior sampling

what parameters do you want to sample?
```{r}
params<-c('rho1', 'mu0','alpha','tau.alpha1','lambda', 'epsilon','eta')

```

```{r}
posterior_samples_flu<-coda.samples(model_jags_flu, 
                                params, 
                                n.iter=10000)
```
## examine lambda
```{r}
test_flu <- gather_draws(posterior_samples_flu, lambda[i])

test_flu %>%
  filter(i==1) %>%
  mutate(.chain=as.factor(.chain)) %>%
ggplot( aes(x=.iteration, y=.value, group=.chain, color=.chain), alpha=0.2) +
  geom_line()+
  theme_classic()


```

```{r}
test_flu2 <- gather_draws(posterior_samples_flu, epsilon[i])

test_flu2 %>%
  filter(i==1) %>%
  mutate(.chain=as.factor(.chain)) %>%
ggplot( aes(x=.iteration, y=.value, group=.chain, color=.chain), alpha=0.2) +
  geom_line()+
  theme_classic()


```

```{r}
test_flu3 <- gather_draws(posterior_samples_flu, eta[i])

test_flu3 %>%
  filter(i==1) %>%
  mutate(.chain=as.factor(.chain)) %>%
ggplot( aes(x=.iteration, y=.value, group=.chain, color=.chain), alpha=0.2) +
  geom_line()+
  theme_classic()


```

HDI for lambda
```{r}
lambda_quant <- test_flu3 %>%
  median_hdi()

ggplot(lambda_quant, aes(x=i, y=.value)) +
  geom_line()+
  theme_minimal()
```


### distributed lag for FLU
```{r}
dl_summary_flu <- gather_draws(posterior_samples_flu, epsilon[m]) %>%
  median_hdi()

ggplot(dl_summary_flu, aes(x=m, y=.value)) +
  geom_line()+
  geom_ribbon(aes(x=m, ymin=.lower, ymax=.upper), alpha=0.2)+
  theme_minimal()+
  geom_hline(yintercept=0, lty=2)

test_flu <- gather_draws(posterior_samples_flu, epsilon[i])

test_flu %>%
  filter(i==1) %>%
  mutate(.chain=as.factor(.chain)) %>%
ggplot( aes(x=.iteration, y=.value, group=.chain, color=.chain), alpha=0.2) +
  geom_line()+
  theme_classic()
```

distributed lag eta (humidity)
```{r}
dl_summary_flu <- gather_draws(posterior_samples_flu, eta[m]) %>%
  median_hdi()

ggplot(dl_summar_fluy, aes(x=m, y=.value)) +
  geom_line()+
  geom_ribbon(aes(x=m, ymin=.lower, ymax=.upper), alpha=0.2)+
  theme_classic()+
  geom_hline(yintercept=0, lty=2)

```


### AR1 component
```{r}
ar1_summary_flu <- gather_draws(posterior_samples_flu, alpha[i]) %>%
  median_hdi()

ggplot(ar1_summary_flu, aes(x=i, y=.value)) +
  geom_line()+
  geom_ribbon(aes(x=i, ymin=.lower, ymax=.upper), alpha=0.2)+
  theme_minimal()

```



## Same model for RSV

### Initialize the model for COVID
```{r}
model_spec<-textConnection(model_string)
model_jags_RSV<-jags.model(model_spec,
                           inits=list(inits1,inits2, inits3),
                           data=list('Ntimes'= nrow(ds1)  ,
                                     'cases'= ds1$RSV_Total,
                                     'pm2_5_mat'=pm2_5_mat,
                                     'dow_mat'=dow_mat,
                                     'humid_mat'=humid_mat
                           ),
                           n.adapt=15000,
                           n.chains=3, quiet=F)
```

### Posterior sampling

what parameters do you want to sample?
  ```{r}
params<-c('rho1', 'mu0','alpha','tau.alpha1','lambda', 'epsilon','eta')

```

```{r}
posterior_samples_RSV<-coda.samples(model_jags_RSV, 
                                    params, 
                                    n.iter=10000)
```
## examine lambda
```{r}
test_RSV <- gather_draws(posterior_samples_RSV, lambda[i])

test_RSV %>%
  filter(i==1) %>%
  mutate(.chain=as.factor(.chain)) %>%
  ggplot( aes(x=.iteration, y=.value, group=.chain, color=.chain), alpha=0.2) +
  geom_line()+
  theme_classic()


```

```{r}
test_RSV2 <- gather_draws(posterior_samples_RSV, epsilon[i])

test_RSV2 %>%
  filter(i==1) %>%
  mutate(.chain=as.factor(.chain)) %>%
  ggplot( aes(x=.iteration, y=.value, group=.chain, color=.chain), alpha=0.2) +
  geom_line()+
  theme_classic()


```

```{r}
test_RSV3 <- gather_draws(posterior_samples_RSV, eta[i])

test_RSV3 %>%
  filter(i==1) %>%
  mutate(.chain=as.factor(.chain)) %>%
  ggplot( aes(x=.iteration, y=.value, group=.chain, color=.chain), alpha=0.2) +
  geom_line()+
  theme_classic()


```

HDI for lambda
```{r}
lambda_quant <- test_RSV3 %>%
  median_hdi()

ggplot(lambda_quant, aes(x=i, y=.value)) +
  geom_line()+
  theme_minimal()
```

### distributed lag for RSV
```{r}
dl_summary_RSV <- gather_draws(posterior_samples_RSV, epsilon[m]) %>%
  median_hdi()

ggplot(dl_summary_RSV, aes(x=m, y=.value)) +
  geom_line()+
  geom_ribbon(aes(x=m, ymin=.lower, ymax=.upper), alpha=0.2)+
  theme_minimal()+
  geom_hline(yintercept=0, lty=2)

test_RSV <- gather_draws(posterior_samples_RSV, epsilon[i])

test_RSV %>%
  filter(i==1) %>%
  mutate(.chain=as.factor(.chain)) %>%
ggplot( aes(x=.iteration, y=.value, group=.chain, color=.chain), alpha=0.2) +
  geom_line()+
  theme_classic()
```

distributed lag eta (humidity)
```{r}
dl_summary_RSV <- gather_draws(posterior_samples_RSV, eta[m]) %>%
  median_hdi()

ggplot(dl_summar_RSVy, aes(x=m, y=.value)) +
  geom_line()+
  geom_ribbon(aes(x=m, ymin=.lower, ymax=.upper), alpha=0.2)+
  theme_classic()+
  geom_hline(yintercept=0, lty=2)

```


### AR1 component
```{r}
ar1_summary_RSV <- gather_draws(posterior_samples_RSV, alpha[i]) %>%
  median_hdi()

ggplot(ar1_summary_RSV, aes(x=i, y=.value)) +
  geom_line()+
  geom_ribbon(aes(x=i, ymin=.lower, ymax=.upper), alpha=0.2)+
  theme_minimal()
